# npmclean 设计文档

## 概述

npmclean 是一款高性能命令行工具，专为高效清理 JavaScript/TypeScript 项目中的 node_modules 目录和构建产物而设计。它基于 Rust 构建，注重速度、安全性和用户体验。

## 核心功能

1. **基本清理**
   - 删除 node_modules 目录
   - 删除构建目录（dist, build, out 等）
   - 支持自定义清理目标

2. **项目检测**
   - 通过 package.json 识别项目
   - 自动检测项目类型（React, Vue, Next.js 等）
   - 针对不同框架的清理策略

3. **批量处理**
   - 递归扫描目录查找项目
   - 按大小排序项目优先清理
   - 多项目并行处理

4. **安全机制**
   - 删除前计算并显示大小
   - 防止意外删除的确认提示
   - 预览操作的干运行模式

## 命令行界面

```txt

用法:
    npmclean [选项] [路径]

参数:
    <路径>    项目或目录路径，默认为当前目录

选项:
    -r, --recursive       递归查找并清理子目录中的项目
    -f, --force           跳过确认提示
    -d, --dry-run         显示将被删除的内容而不实际删除
    -c, --config <文件>   使用指定配置文件
    -n, --node-modules    仅清理 node_modules 目录
    -b, --build           仅清理构建目录
    --include <目录>      额外清理的目录（逗号分隔）
    --exclude <目录>      排除的目录（逗号分隔）
    -s, --stats           显示节省空间的统计信息
    -v, --verbose         显示详细输出
    -h, --help            显示帮助信息
```

## 配置系统

配置可以通过以下方式定义：

- 命令行参数（最高优先级）
- 项目级配置（.npmcleanrc.yml 或 npmclean.config.yml）
- 用户级配置（~/.npmcleanrc.yml）
- 内置默认配置（最低优先级）

配置文件示例：

```yaml
# 要清理的目标目录
targets:
  - node_modules
  - dist
  - build
  - .next
  - coverage

# 从清理中排除的目录
exclude:
  - some-special-module

# 一般选项
confirmDelete: true
stats: true
recursive: false
```

## 扩展点

该工具设计了多个扩展点，以便于未来增强功能：

1. **插件系统**
   - 支持自定义项目检测器
   - 支持自定义清理策略
   - 清理前后钩子系统

2. **项目类型检测**
   - 可扩展的检测器接口
   - 框架特定检测器注册表
   - 自定义检测规则

3. **目录过滤器**
   - 通过配置的自定义过滤规则
   - 通过插件的可编程过滤器

4. **输出格式化器**
   - 可扩展的输出格式系统
   - 支持不同输出格式（文本、JSON等）

## 技术实现

### 项目结构

```txt
src/
  ├── main.rs           # 入口点
  ├── cli.rs            # 命令行参数处理
  ├── config/           # 配置处理
  │   ├── mod.rs        # 配置模块导出
  │   ├── loader.rs     # 配置加载
  │   └── schema.rs     # 配置模式验证
  ├── project/          # 项目检测和分析
  │   ├── mod.rs        # 项目模块导出
  │   ├── detector.rs   # 项目检测逻辑
  │   └── analyzers/    # 框架特定分析器
  ├── cleaner/          # 清理操作
  │   ├── mod.rs        # 清理模块导出
  │   ├── engine.rs     # 清理协调
  │   └── strategies/   # 清理策略
  ├── scanner.rs        # 目录扫描逻辑
  ├── plugins/          # 插件系统
  │   ├── mod.rs        # 插件模块导出
  │   └── registry.rs   # 插件注册
  ├── utils/
  │   ├── fs.rs         # 文件系统操作
  │   ├── size.rs       # 目录大小计算
  │   └── display.rs    # 输出格式化
  └── tests/            # 测试
```

### 关键组件

1. **配置系统**
   - 合并多个来源的配置
   - 根据模式进行验证
   - 为缺失的值提供默认值

2. **项目检测**
   - 项目检测的抽象接口
   - 标准 JS/TS 项目的实现
   - 框架特定检测器
   - 支持自定义检测器的插件

3. **清理引擎**
   - 协调清理过程
   - 应用安全检查
   - 管理统计信息收集
   - 触发适当的清理策略

4. **扫描器**
   - 快速目录遍历
   - 过滤机制
   - 大小计算
   - 项目检测器集成

5. **插件系统**
   - 注册机制
   - 生命周期钩子
   - 配置集成

### 性能考虑

1. **并行处理**
   - 多线程项目扫描
   - 并行项目清理
   - 基于目录大小的工作负载平衡

2. **特定操作系统的优化**
   - Windows 特定目录删除优化
   - Unix 特定快速路径操作
   - 平台检测和策略选择

3. **内存管理**
   - 大目录的流处理
   - 有界内存使用
   - 可取消操作

## 未来扩展

1. **包管理器集成**
   - npm, yarn, pnpm 的自定义钩子
   - 脚本集成模板

2. **高级项目类型检测**
   - 基于机器学习的项目分类
   - 构建系统分析

3. **全局 Node 模块管理**
   - 全局安装清理
   - 版本管理

4. **用户界面**
   - 交互式文本用户界面版本
   - GUI 应用程序
   - IDE 插件

5. **远程操作**
   - 清理远程服务器上的项目
   - CI/CD 集成

## 实施阶段

1. **第一阶段：核心功能**
   - 基本命令行界面
   - 本地项目清理
   - 简单项目检测
   
2. **第二阶段：增强功能**
   - 配置系统
   - 高级项目检测
   - 性能优化
   
3. **第三阶段：扩展系统**
   - 插件架构
   - 自定义清理策略
   - 钩子系统
   
4. **第四阶段：集成**
   - 包管理器集成
   - CI/CD 系统集成 